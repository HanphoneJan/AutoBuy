<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自动抢购工具</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .material-icons {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>
                    <span class="material-icons">shopping_cart</span>
                    <span>自动抢购</span>
                </h1>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <input type="radio" name="platform" value="jd" id="nav-jd" onchange="updatePlatform()">
                    <label for="nav-jd" class="nav-label">
                        <span class="nav-icon material-icons">inventory_2</span>
                        <span class="nav-text">京东</span>
                    </label>
                </div>
                <div class="nav-item">
                    <input type="radio" name="platform" value="tb" id="nav-tb" checked onchange="updatePlatform()">
                    <label for="nav-tb" class="nav-label">
                        <span class="nav-icon material-icons">store</span>
                        <span class="nav-text">淘宝</span>
                    </label>
                </div>
            </nav>
            <div class="sidebar-instructions" id="jdInstructions" style="display: none;">
                <h3>京东使用说明</h3>
                <ol>
                    <li>选择"京东"平台并设置抢购时间</li>
                    <li>点击"开始抢购"按钮</li>
                    <li>在弹出的浏览器中扫码登录京东账号</li>
                    <li>登录完成后，点击页面上的"确认登录"按钮</li>
                    <li>手动进入购物车，勾选需要抢购的商品</li>
                    <li>点击页面上的"确认购物车"按钮</li>
                    <li>等待到达抢购时间，系统自动提交订单</li>
                </ol>
            </div>
            <div class="sidebar-instructions" id="tbInstructions">
                <h3>淘宝使用说明</h3>
                <ol>
                    <li>选择"淘宝"平台</li>
                    <li>点击"开始抢购"按钮</li>
                    <li>在弹出的浏览器中登录淘宝账号</li>
                    <li>登录完成后，点击页面上的"确认登录"按钮</li>
                    <li>手动进入购物车，勾选需要抢购的商品</li>
                    <li>点击页面上的"确认购物车"按钮</li>
                    <li>等待到达抢购时间，系统自动点击结算和提交订单</li>
                </ol>
            </div>
            <div class="sidebar-footer">
                <a href="/help" class="footer-link">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">help_outline</span>
                    使用帮助
                </a>
                <p class="footer-text">
                    <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
                    仅用于学习交流
                </p>
            </div>
        </aside>

        <main class="main-content">
            <div class="content-wrapper">
                <section class="time-section" id="timeSection">
                    <div class="section-header">
                        <h2>设置抢购时间</h2>
                    </div>
                    <div class="time-inputs">
                        <div class="form-group">
                            <label for="targetDate">日期</label>
                            <input type="date" id="targetDate">
                        </div>
                        <div class="form-group">
                            <label for="targetHour">时</label>
                            <select id="targetHour"></select>
                        </div>
                        <div class="form-group">
                            <label for="targetMinute">分</label>
                            <select id="targetMinute"></select>
                        </div>
                        <div class="form-group">
                            <label for="targetSecond">秒</label>
                            <select id="targetSecond"></select>
                        </div>
                        <div class="form-group">
                            <label for="targetMicrosecond">毫秒</label>
                            <select id="targetMicrosecond">
                                <option value="0" selected>000</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                                <option value="300">300</option>
                                <option value="400">400</option>
                                <option value="500">500</option>
                                <option value="600">600</option>
                                <option value="700">700</option>
                                <option value="800">800</option>
                                <option value="900">900</option>
                            </select>
                        </div>
                    </div>
                    <div class="quick-select">
                        <button type="button" onclick="quickSelect(1)" class="btn btn-secondary">明天</button>
                        <button type="button" onclick="quickSelect(0)" class="btn btn-secondary">今天</button>
                    </div>
                </section>

                <section class="control-section">
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-labels">
                            <div class="progress-step" id="step1">
                                <span class="step-number">1</span>
                                <span class="step-label">驱动检查</span>
                            </div>
                            <div class="progress-step" id="step2">
                                <span class="step-number">2</span>
                                <span class="step-label">登录确认</span>
                                <button class="step-confirm-btn" id="confirmLoginBtn" onclick="confirmStage('login')" disabled>确认登录</button>
                            </div>
                            <div class="progress-step" id="step3">
                                <span class="step-number">3</span>
                                <span class="step-label">购物车确认</span>
                                <button class="step-confirm-btn" id="confirmCartBtn" onclick="confirmStage('cart')" disabled>确认购物车</button>
                            </div>
                            <div class="progress-step" id="step4">
                                <span class="step-number">4</span>
                                <span class="step-label">执行抢购</span>
                            </div>
                            <div class="progress-step" id="step5">
                                <span class="step-number">5</span>
                                <span class="step-label">抢购完成</span>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="startTask()" class="btn btn-primary" id="startBtn">开始抢购</button>
                        <button onclick="closeBrowser()" class="btn btn-secondary" id="closeBrowserBtn" disabled>关闭浏览器</button>
                        <button onclick="resetTask()" class="btn btn-secondary" id="resetBtn">重置</button>
                        <button onclick="stopTask()" class="btn btn-danger" id="stopBtn" disabled>停止</button>
                    </div>
                </section>

                <section class="log-section">
                    <div class="log-header">
                        <h2>实时日志</h2>
                        <span id="status" class="status-badge"></span>
                    </div>
                    <div id="logContainer" class="log-container">
                        <div class="log-entry"><span class="log-time">--:--:--</span>等待开始...</div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // 初始化时间选择器
        function initTimeSelectors() {
            // 设置默认日期和时间为当前时间
            const now = new Date();
            document.getElementById('targetDate').value = now.toISOString().split('T')[0];

            // 初始化小时并设置为当前小时
            const hourSelect = document.getElementById('targetHour');
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.text = String(i).padStart(2, '0');
                hourSelect.appendChild(option);
            }
            hourSelect.value = String(now.getHours()).padStart(2, '0');

            // 初始化分钟并设置为当前分钟
            const minuteSelect = document.getElementById('targetMinute');
            for (let i = 0; i < 60; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.text = String(i).padStart(2, '0');
                minuteSelect.appendChild(option);
            }
            minuteSelect.value = String(now.getMinutes()).padStart(2, '0');

            // 初始化秒并设置为当前秒数
            const secondSelect = document.getElementById('targetSecond');
            for (let i = 0; i < 60; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.text = String(i).padStart(2, '0');
                secondSelect.appendChild(option);
            }
            secondSelect.value = '00';
        }

        // 快速选择今天或明天
        function quickSelect(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            document.getElementById('targetDate').value = date.toISOString().split('T')[0];
        }

        // 获取格式化的时间字符串
        function getFormattedTime() {
            const date = document.getElementById('targetDate').value;
            const hour = document.getElementById('targetHour').value;
            const minute = document.getElementById('targetMinute').value;
            const second = document.getElementById('targetSecond').value;
            const microsecond = document.getElementById('targetMicrosecond').value;

            if (!date) {
                alert('请选择日期');
                return null;
            }

            return `${date} ${hour}:${minute}:${second}.${microsecond}000`;
        }

        // 更新平台选择
        function updatePlatform() {
            const platform = document.querySelector('input[name="platform"]:checked').value;
            const jdInstructions = document.getElementById('jdInstructions');
            const tbInstructions = document.getElementById('tbInstructions');

            if (platform === 'jd') {
                jdInstructions.style.display = 'block';
                tbInstructions.style.display = 'none';
            } else if (platform === 'tb') {
                jdInstructions.style.display = 'none';
                tbInstructions.style.display = 'block';
            }
        }

        // 确认当前阶段
        async function confirmStage(stage) {
            if (!currentTaskId) {
                alert('请先开始抢购任务');
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${currentTaskId}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stage })
                });

                const data = await response.json();

                if (data.status === 'ok') {
                    // 更新按钮状态
                    if (stage === 'login') {
                        const confirmLoginBtn = document.getElementById('confirmLoginBtn');
                        if (confirmLoginBtn) {
                            confirmLoginBtn.disabled = true;
                            confirmLoginBtn.textContent = '已确认';
                        }
                    } else if (stage === 'cart') {
                        const confirmCartBtn = document.getElementById('confirmCartBtn');
                        if (confirmCartBtn) {
                            confirmCartBtn.disabled = true;
                            confirmCartBtn.textContent = '已确认';
                        }
                    }
                }
            } catch (error) {
                alert('确认失败：' + error.message);
            }
        }

        // 页面加载时初始化
        window.onload = function() {
            initTimeSelectors();
            updatePlatform();
            updateSteps(0);
        };

        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
    </script>
    <script src="/static/js/seckill.js"></script>
</body>
</html>
